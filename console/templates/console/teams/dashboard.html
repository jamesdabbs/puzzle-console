{% extends 'console/base.html' %}
{% load markup %}
{% load url from future %}

{% block title %}
About {{ game.name }}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ game.name|default:"Unknown Game" }}</h1>
    <h3>Dashboard</h3>
</div>

<section>

<div class="row">
    <div class="span8">
        {% for prog in team.puzzleprogress_set.all %}
        {% with prog.puzzle as p %}
        <div class="well well-large">
            <h3>{{ p.number }}. {{ p.title }} <small>{{ prog.get_status_display }}</small></h3>
            <p>{{ p.description|markdown }}</p>
            {% if prog.status == prog.OPENED %}
                {% with prog.time_remaining as tr %}
                <h5>Time remaining <small>{{ tr.1 }}% | {{ tr.0 }}</small></h5>
                <div class="progress">
                    <div class="bar" style="width: {{ tr.1 }}%;"></div>
                </div>
                {% endwith %}
            {% else %}
                <h5>Closes @ {{ p.close|time }} <small>in {{ p.close|timeuntil }}</small></h5>
                <form action="{% url 'unlock_puzzle' id=p.id %}" method="POST">
                    {% csrf_token %}
                    <input type="submit" class="btn btn-success" value="Open">
                </form>
            {% endif %}
        </div>
        {% endwith %}
        {% endfor %}
    </div>

    <div class="span4">
        <form action="{% url 'solve_puzzle' %}" method="POST">
            {% csrf_token %}
            <p>Enter code:</p>
            <p style="text-align:center"><input type="text" name="code" class="span2" /></p>
            <input type="submit" class="btn" value="Submit">
        </form>
        <div class="well well-small">
            <b>Points</b><br />
            {{ team.points }}
        </div>
        <div class="well" id="achievements" style="height:300px;overflow:auto">
            <h4>Achievements</h4>
            {% for a in team.achievements|slice:":5" %}
            <p>{{ a.description }}</p>
            <hr />
            {% empty %}
            <p>Nothing yet. Get to puzzling!</p>
            {% endfor %}
        </div>
    </div>
</div>

</section>
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript">
$(function() {

    var update_time_remaining = function() {
        // TODO
    };

    var status_hash = '',
        check_for_updates = function() {
            $.ajax({
                // TODO
                success: function(new_status) {
                    if (status_hash) {
                        if (status_hash != new_status) {
                            status_update();
                        }
                    } else {
                        status_hash = new_status;
                    }
                }
            })
    }

    var status_update = function() {
        // TODO: alert message? or jQuery.load in stuff?
    }

});
</script>
{% endblock %}